import os
import httpx
from fastapi import APIRouter, HTTPException, Body, Request
from pydantic import BaseModel
from typing import List, Optional
from dotenv import load_dotenv
from datetime import datetime

load_dotenv()

router = APIRouter()

# WhatsApp Business API Configuration
WHATSAPP_TOKEN = os.getenv("WHATSAPP_TOKEN")
WHATSAPP_PHONE_NUMBER_ID = os.getenv("WHATSAPP_PHONE_NUMBER_ID")
WHATSAPP_VERIFY_TOKEN = os.getenv("WHATSAPP_VERIFY_TOKEN", "superdashboard_verify_token")
WHATSAPP_API_VERSION = os.getenv("WHATSAPP_API_VERSION", "v18.0")

# In-memory storage for messages (replace with database in production)
messages_db = []

class WhatsAppMessage(BaseModel):
    id: Optional[str] = None
    from_number: str
    to_number: str
    message: str
    timestamp: str
    status: str = "sent"  # sent, delivered, read, failed
    message_type: str = "text"  # text, image, document, etc.

class SendMessageRequest(BaseModel):
    to: str
    message: str
    message_type: str = "text"

class WebhookEntry(BaseModel):
    entry: List[dict]

@router.get("/health")
async def health_check():
    """Health check endpoint"""
    is_configured = bool(WHATSAPP_TOKEN and WHATSAPP_PHONE_NUMBER_ID)
    return {
        "status": "healthy",
        "configured": is_configured,
        "api_version": WHATSAPP_API_VERSION
    }

@router.get("/webhook")
async def verify_webhook(request: Request):
    """
    Webhook verification endpoint for WhatsApp
    WhatsApp will send a GET request to verify the webhook
    """
    mode = request.query_params.get("hub.mode")
    token = request.query_params.get("hub.verify_token")
    challenge = request.query_params.get("hub.challenge")

    if mode == "subscribe" and token == WHATSAPP_VERIFY_TOKEN:
        return int(challenge)
    else:
        raise HTTPException(status_code=403, detail="Verification failed")

@router.post("/webhook")
async def receive_webhook(request: Request):
    """
    Webhook endpoint to receive incoming WhatsApp messages
    """
    try:
        data = await request.json()

        # Process incoming messages
        if data.get("object") == "whatsapp_business_account":
            for entry in data.get("entry", []):
                for change in entry.get("changes", []):
                    value = change.get("value", {})

                    # Handle incoming messages
                    if "messages" in value:
                        for message in value["messages"]:
                            msg = WhatsAppMessage(
                                id=message.get("id"),
                                from_number=message.get("from"),
                                to_number=value.get("metadata", {}).get("display_phone_number", ""),
                                message=message.get("text", {}).get("body", ""),
                                timestamp=datetime.fromtimestamp(int(message.get("timestamp"))).isoformat(),
                                status="received",
                                message_type=message.get("type", "text")
                            )
                            messages_db.append(msg)

                    # Handle message status updates
                    if "statuses" in value:
                        for status in value["statuses"]:
                            msg_id = status.get("id")
                            new_status = status.get("status")

                            # Update message status in database
                            for msg in messages_db:
                                if msg.id == msg_id:
                                    msg.status = new_status

        return {"status": "ok"}
    except Exception as e:
        print(f"Webhook error: {e}")
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/messages/send")
async def send_message(request: SendMessageRequest):
    """
    Send a WhatsApp message
    """
    if not all([WHATSAPP_TOKEN, WHATSAPP_PHONE_NUMBER_ID]):
        raise HTTPException(
            status_code=400,
            detail="WhatsApp credentials not configured. Please set WHATSAPP_TOKEN and WHATSAPP_PHONE_NUMBER_ID in .env"
        )

    url = f"https://graph.facebook.com/{WHATSAPP_API_VERSION}/{WHATSAPP_PHONE_NUMBER_ID}/messages"

    headers = {
        "Authorization": f"Bearer {WHATSAPP_TOKEN}",
        "Content-Type": "application/json"
    }

    payload = {
        "messaging_product": "whatsapp",
        "recipient_type": "individual",
        "to": request.to,
        "type": "text",
        "text": {
            "preview_url": False,
            "body": request.message
        }
    }

    try:
        async with httpx.AsyncClient() as client:
            response = await client.post(url, json=payload, headers=headers)

            if response.status_code != 200:
                print(f"WhatsApp API Error: {response.status_code} - {response.text}")
                raise HTTPException(
                    status_code=response.status_code,
                    detail=f"WhatsApp API Error: {response.text}"
                )

            data = response.json()

            # Store sent message
            msg = WhatsAppMessage(
                id=data.get("messages", [{}])[0].get("id"),
                from_number=WHATSAPP_PHONE_NUMBER_ID,
                to_number=request.to,
                message=request.message,
                timestamp=datetime.now().isoformat(),
                status="sent",
                message_type=request.message_type
            )
            messages_db.append(msg)

            return {
                "success": True,
                "message_id": msg.id,
                "status": "sent"
            }

    except httpx.HTTPError as e:
        raise HTTPException(status_code=500, detail=f"HTTP error occurred: {str(e)}")
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Error sending message: {str(e)}")

@router.get("/messages", response_model=List[WhatsAppMessage])
async def get_messages(phone_number: Optional[str] = None):
    """
    Get all messages, optionally filtered by phone number
    """
    if phone_number:
        filtered = [
            msg for msg in messages_db
            if msg.from_number == phone_number or msg.to_number == phone_number
        ]
        return filtered
    return messages_db

@router.get("/conversations")
async def get_conversations():
    """
    Get list of unique conversations (phone numbers)
    """
    phone_numbers = set()
    for msg in messages_db:
        if msg.from_number != WHATSAPP_PHONE_NUMBER_ID:
            phone_numbers.add(msg.from_number)
        if msg.to_number != WHATSAPP_PHONE_NUMBER_ID:
            phone_numbers.add(msg.to_number)

    conversations = []
    for phone in phone_numbers:
        # Get latest message for this conversation
        conv_messages = [
            msg for msg in messages_db
            if msg.from_number == phone or msg.to_number == phone
        ]

        if conv_messages:
            latest = max(conv_messages, key=lambda m: m.timestamp)
            conversations.append({
                "phone_number": phone,
                "last_message": latest.message,
                "last_message_time": latest.timestamp,
                "unread_count": sum(1 for m in conv_messages if m.status == "received" and m.from_number == phone),
                "message_count": len(conv_messages)
            })

    # Sort by latest message time
    conversations.sort(key=lambda c: c["last_message_time"], reverse=True)

    return conversations

@router.delete("/messages")
async def clear_messages():
    """
    Clear all messages (for testing purposes)
    """
    messages_db.clear()
    return {"message": "All messages cleared"}

@router.get("/messages/{message_id}")
async def get_message(message_id: str):
    """
    Get a specific message by ID
    """
    for msg in messages_db:
        if msg.id == message_id:
            return msg
    raise HTTPException(status_code=404, detail="Message not found")
